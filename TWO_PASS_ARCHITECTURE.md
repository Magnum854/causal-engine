# åŒé˜¶æ®µæ¶æ„ + æ•°æ®æº¯æºç³»ç»Ÿ - å®Œæ•´æŒ‡å—

## æ¶æ„æ¦‚è¿°

### æ ¸å¿ƒé—®é¢˜
ä¼ ç»Ÿå› æœå¼•æ“åªèƒ½ç”Ÿæˆé™æ€æ‹“æ‰‘å›¾ï¼Œæ— æ³•è·å–èŠ‚ç‚¹çš„å®æ—¶çŠ¶æ€ï¼Œä¹Ÿæ— æ³•è¿½æº¯æ•°æ®æ¥æºã€‚

### è§£å†³æ–¹æ¡ˆï¼šTwo-Pass Pipeline with Data Provenance

```
Pass 1: æ‹“æ‰‘ç”Ÿæˆ
  è¾“å…¥: "é»„é‡‘ä»·æ ¼çš„å½±å“å› ç´ "
  LLM åˆ†æ â†’ ç”Ÿæˆå› æœå›¾è°±
  æ¯ä¸ªèŠ‚ç‚¹åŒ…å« search_query å­—æ®µ
  â†“
  è¾“å‡º: {
    nodes: [
      {id: "n1", label: "ç¾å…ƒæŒ‡æ•°", search_query: "ç¾å…ƒæŒ‡æ•°æœ€æ–°èµ°åŠ¿"},
      {id: "n2", label: "ç¾è”å‚¨åˆ©ç‡", search_query: "ç¾è”å‚¨åˆ©ç‡å†³è®®"}
    ],
    edges: [...]
  }

Pass 2: åŠ¨æ€å¯ŒåŒ– + æ•°æ®æº¯æº
  æå–æ‰€æœ‰ search_query
  å¹¶å‘è°ƒç”¨æœç´¢å¼•æ“ï¼ˆçœŸå® API æˆ– Mockï¼‰
  LLM è§£ææœç´¢ç»“æœ
  â†“
  è¾“å‡º: {
    nodes: [
      {
        id: "n1",
        label: "ç¾å…ƒæŒ‡æ•°",
        realtime_state: {
          latest_value: "103.5",
          sources: [
            {
              title: "ç¾å…ƒæŒ‡æ•°å‡è‡³103.5",
              url: "https://www.reuters.com/...",
              domain: "reuters.com"
            }
          ],
          updated_at: "2024-02-19T10:30:00Z"
        }
      }
    ]
  }
```

---

## API ä½¿ç”¨

### POST `/api/v1/analyze-v2`

**è¯·æ±‚ï¼š**

```json
{
  "query": "é»„é‡‘ä»·æ ¼çš„å½±å“å› ç´ ",
  "context": "åˆ†æå½“å‰å¸‚åœºç¯å¢ƒ",
  "max_depth": 3
}
```

**å“åº”ï¼š**

```json
{
  "nodes": [
    {
      "id": "n1",
      "label": "ç¾å…ƒæŒ‡æ•°",
      "type": "cause",
      "description": "ç¾å…ƒç›¸å¯¹å…¶ä»–ä¸»è¦è´§å¸çš„å¼ºå¼±æŒ‡æ ‡",
      "search_query": "ç¾å…ƒæŒ‡æ•°æœ€æ–°èµ°åŠ¿ US Dollar Index DXY latest",
      "realtime_state": {
        "latest_value": "103.5",
        "sources": [
          {
            "title": "ç¾å…ƒæŒ‡æ•°å‡è‡³103.5ï¼Œåˆ›ä¸¤ä¸ªæœˆæ–°é«˜",
            "url": "https://www.reuters.com/markets/currencies/dollar-index-2024",
            "domain": "reuters.com"
          },
          {
            "title": "US Dollar Index Rises on Fed Hawkish Stance",
            "url": "https://www.bloomberg.com/news/dollar-strength-2024",
            "domain": "bloomberg.com"
          }
        ],
        "updated_at": "2024-02-19T10:30:00Z"
      }
    }
  ],
  "edges": [...],
  "explanation": "..."
}
```

---

## å‰ç«¯ UI ç‰¹æ€§

### 1. èŠ‚ç‚¹å¡ç‰‡å¢å¼º

**å®æ—¶çŠ¶æ€æ ï¼ˆåº•éƒ¨ï¼‰ï¼š**
- æ˜¾ç¤º `latest_value`ï¼ˆå¦‚ "103.5"ï¼‰
- æ˜¾ç¤ºæ›´æ–°æ—¶é—´

**æ•°æ®æºè§’æ ‡ï¼ˆå³ä¸Šè§’ï¼‰ï¼š**
- æ˜¾ç¤º ğŸ”— å›¾æ ‡ + åŸŸåï¼ˆå¦‚ "reuters.com"ï¼‰
- Hover æ˜¾ç¤ºå®Œæ•´æ ‡é¢˜
- å¦‚æœæœ‰å¤šä¸ªæ¥æºï¼Œæ˜¾ç¤º "+N ä¸ªå…¶ä»–æ¥æº"

### 2. å…¨å±€æ•°æ®æºé¢æ¿ï¼ˆåº•éƒ¨ï¼‰

**åŠŸèƒ½ï¼š**
- è‡ªåŠ¨æå–æ‰€æœ‰èŠ‚ç‚¹çš„æ•°æ®æºå¹¶å»é‡
- åˆ—è¡¨å±•ç¤ºï¼š[èŠ‚ç‚¹åç§°] - [æ–°é—»æ ‡é¢˜] - [å¯ç‚¹å‡»é“¾æ¥]
- ç‚¹å‡»å±•å¼€/æ”¶èµ·
- æœ€å¤§é«˜åº¦ 264pxï¼Œè¶…å‡ºæ»šåŠ¨

**ç¤ºä¾‹ï¼š**

```
ğŸ“š åˆ†æå¼•ç”¨çš„æ•°æ®æº
å…± 5 æ¡æ¥æº Â· ç‚¹å‡»å±•å¼€/æ”¶èµ·

1. æ¥è‡ªèŠ‚ç‚¹: ç¾å…ƒæŒ‡æ•°
   ç¾å…ƒæŒ‡æ•°å‡è‡³103.5ï¼Œåˆ›ä¸¤ä¸ªæœˆæ–°é«˜
   reuters.com æŸ¥çœ‹åŸæ–‡ â†—

2. æ¥è‡ªèŠ‚ç‚¹: ç¾è”å‚¨åˆ©ç‡
   ç¾è”å‚¨ç»´æŒåˆ©ç‡åœ¨5.25%-5.50%ä¸å˜
   federalreserve.gov æŸ¥çœ‹åŸæ–‡ â†—
```

---

## Mock æ¨¡å¼

### ä¸ºä»€ä¹ˆéœ€è¦ Mockï¼Ÿ

åœ¨å¼€å‘/æµ‹è¯•ç¯å¢ƒä¸­ï¼Œå¯èƒ½æ²¡æœ‰é…ç½®çœŸå®çš„æœç´¢å¼•æ“ APIã€‚Mock æ¨¡å¼å…è®¸ä½ ï¼š
- æ— éœ€ API å¯†é’¥å³å¯æµ‹è¯•å®Œæ•´æµç¨‹
- æ¨¡æ‹ŸçœŸå®çš„ç½‘ç»œå»¶è¿Ÿï¼ˆ500ms-1500msï¼‰
- è¿”å›ç¬¦åˆçœŸå®åœºæ™¯çš„æ¨¡æ‹Ÿæ•°æ®

### Mock æ•°æ®ç¤ºä¾‹

**æŸ¥è¯¢ï¼š** "ç¾å…ƒæŒ‡æ•°æœ€æ–°èµ°åŠ¿"

**Mock è¿”å›ï¼š**
```json
[
  {
    "title": "ç¾å…ƒæŒ‡æ•°å‡è‡³103.5ï¼Œåˆ›ä¸¤ä¸ªæœˆæ–°é«˜",
    "url": "https://www.reuters.com/markets/currencies/dollar-index-2024",
    "snippet": "ç¾å…ƒæŒ‡æ•°å‘¨ä¸‰å‡è‡³103.5ï¼Œå—ç¾è”å‚¨é¹°æ´¾ç«‹åœºæ”¯æ’‘..."
  },
  {
    "title": "US Dollar Index Rises on Fed Hawkish Stance",
    "url": "https://www.bloomberg.com/news/dollar-strength-2024",
    "snippet": "The US Dollar Index (DXY) climbed to 103.5..."
  }
]
```

### å¯ç”¨ Mock æ¨¡å¼

**è‡ªåŠ¨å¯ç”¨ï¼š** å¦‚æœ `.env` ä¸­æœªé…ç½® `TAVILY_API_KEY` å’Œ `SERPER_API_KEY`ï¼Œç³»ç»Ÿè‡ªåŠ¨ä½¿ç”¨ Mock æ¨¡å¼ã€‚

**æ—¥å¿—æç¤ºï¼š**
```
[æœç´¢å¼•æ“] æœªé…ç½®çœŸå® APIï¼Œå°†ä½¿ç”¨ Mock æ¨¡å¼
[Mock Search] æ¨¡æ‹Ÿæœç´¢: ç¾å…ƒæŒ‡æ•°æœ€æ–°èµ°åŠ¿
[Mock Search] è¿”å› 2 æ¡æ¨¡æ‹Ÿç»“æœ
```

---

## æ•°æ®æµè½¬è¯¦è§£

### Pass 1: æ‹“æ‰‘ç”Ÿæˆ

**LLM Prompt å…³é”®è¦æ±‚ï¼š**
```
æ¯ä¸ªèŠ‚ç‚¹å¿…é¡»åŒ…å« search_query å­—æ®µ
search_query åº”è¯¥æ˜¯ç²¾å‡†çš„æœç´¢å…³é”®è¯
å¯¹äºæ•°å€¼å‹èŠ‚ç‚¹ï¼Œsearch_query åº”åŒ…å«"æœ€æ–°"ã€"latest"ç­‰æ—¶æ•ˆè¯
```

**éªŒè¯é€»è¾‘ï¼š**
```python
for node in result["nodes"]:
    if "search_query" not in node:
        logger.warning(f"èŠ‚ç‚¹ {node.get('id')} ç¼ºå°‘ search_queryï¼Œè‡ªåŠ¨ç”Ÿæˆ")
        node["search_query"] = f"{node.get('label', '')} latest news"
```

### Pass 2: åŠ¨æ€å¯ŒåŒ–

**å¹¶å‘å¤„ç†ï¼š**
```python
enriched_nodes = await asyncio.gather(
    *[self._enrich_single_node(node) for node in nodes],
    return_exceptions=True
)
```

**æœç´¢å¼•æ“è°ƒç”¨ï¼š**
```python
if self.use_mock:
    return await self._mock_search_api(query)
elif self.tavily_api_key:
    return await self._search_tavily(query)
elif self.serper_api_key:
    return await self._search_serper(query)
```

**LLM è§£æï¼š**
```python
system_prompt = """
æå–è§„åˆ™ï¼š
1. å¦‚æœæœ‰æ˜ç¡®æ•°å€¼ï¼Œæå–æ•°å€¼
2. å¦‚æœæ²¡æœ‰æ˜ç¡®æ•°å€¼ï¼Œç”¨ç®€çŸ­æè¿°
3. å¦‚æœå®Œå…¨æ— æ³•ç¡®å®šï¼Œè®¾ä¸º "unknown"
4. ä¸è¦ç¼–é€ æ•°æ®ï¼Œä¸¥æ ¼åŸºäºæœç´¢ç»“æœ
"""
```

**æ•°æ®æº¯æºï¼š**
```python
sources = []
for r in search_results[:3]:
    url = r.get("url", "")
    domain = urlparse(url).netloc
    
    sources.append({
        "title": r.get("title", ""),
        "url": url,
        "domain": domain
    })
```

---

## ç¯å¢ƒé…ç½®

### å¼€å‘ç¯å¢ƒï¼ˆMock æ¨¡å¼ï¼‰

```bash
# backend/.env
OPENAI_API_KEY=your-deepseek-api-key
OPENAI_BASE_URL=https://api.deepseek.com/v1
OPENAI_MODEL=deepseek-reasoner

# ä¸é…ç½®æœç´¢å¼•æ“ APIï¼Œè‡ªåŠ¨ä½¿ç”¨ Mock
```

### ç”Ÿäº§ç¯å¢ƒï¼ˆçœŸå® APIï¼‰

```bash
# backend/.env
OPENAI_API_KEY=your-deepseek-api-key
OPENAI_BASE_URL=https://api.deepseek.com/v1
OPENAI_MODEL=deepseek-reasoner

# é…ç½®è‡³å°‘ä¸€ä¸ªæœç´¢å¼•æ“ API
TAVILY_API_KEY=your-tavily-api-key
SERPER_API_KEY=your-serper-api-key
```

---

## æµ‹è¯•æµç¨‹

### 1. å¯åŠ¨åç«¯

```bash
cd backend
python main.py
```

### 2. å¯åŠ¨å‰ç«¯

```bash
cd frontend
npm run dev
```

### 3. æµ‹è¯•åˆ†æ

**è¾“å…¥ï¼š** "é»„é‡‘ä»·æ ¼çš„å½±å“å› ç´ "

**é¢„æœŸç»“æœï¼š**
- Pass 1: ç”Ÿæˆ 3-5 ä¸ªèŠ‚ç‚¹ï¼ˆç¾å…ƒæŒ‡æ•°ã€ç¾è”å‚¨åˆ©ç‡ã€åœ°ç¼˜æ”¿æ²»ç­‰ï¼‰
- Pass 2: æ¯ä¸ªèŠ‚ç‚¹æ˜¾ç¤ºå®æ—¶çŠ¶æ€ï¼ˆå¦‚ "103.5"ï¼‰
- èŠ‚ç‚¹å³ä¸Šè§’æ˜¾ç¤ºæ•°æ®æºè§’æ ‡ï¼ˆå¦‚ "reuters.com"ï¼‰
- åº•éƒ¨é¢æ¿æ˜¾ç¤ºæ‰€æœ‰å¼•ç”¨æ¥æº

### 4. éªŒè¯æ•°æ®æº¯æº

**æ£€æŸ¥èŠ‚ç‚¹å¡ç‰‡ï¼š**
- Hover å³ä¸Šè§’ ğŸ”— å›¾æ ‡
- åº”æ˜¾ç¤ºå®Œæ•´æ–°é—»æ ‡é¢˜

**æ£€æŸ¥åº•éƒ¨é¢æ¿ï¼š**
- ç‚¹å‡»å±•å¼€
- åº”æ˜¾ç¤ºæ‰€æœ‰èŠ‚ç‚¹çš„æ•°æ®æº
- ç‚¹å‡»é“¾æ¥åº”è·³è½¬åˆ°åŸæ–‡

---

## æ€§èƒ½æŒ‡æ ‡

### Pass 1: æ‹“æ‰‘ç”Ÿæˆ
- **è€—æ—¶**: 5-8 ç§’
- **LLM è°ƒç”¨**: 1 æ¬¡

### Pass 2: åŠ¨æ€å¯ŒåŒ–
- **è€—æ—¶**: 10-15 ç§’ï¼ˆå¹¶å‘ï¼‰
- **æœç´¢å¼•æ“è°ƒç”¨**: N æ¬¡ï¼ˆN = èŠ‚ç‚¹æ•°ï¼‰
- **LLM è°ƒç”¨**: N æ¬¡ï¼ˆè§£ææœç´¢ç»“æœï¼‰

### æ€»è€—æ—¶
- **å¼€å‘ç¯å¢ƒï¼ˆMockï¼‰**: 15-20 ç§’
- **ç”Ÿäº§ç¯å¢ƒï¼ˆçœŸå® APIï¼‰**: 20-30 ç§’

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: èŠ‚ç‚¹æ²¡æœ‰æ˜¾ç¤ºå®æ—¶çŠ¶æ€

**åŸå› ï¼š**
- Pass 1 ç”Ÿæˆçš„èŠ‚ç‚¹ç¼ºå°‘ `search_query`
- Pass 2 æœç´¢å¤±è´¥

**è§£å†³ï¼š**
- æ£€æŸ¥æ—¥å¿—ï¼š`[Pass 1]` å’Œ `[Pass 2]`
- ç¡®è®¤èŠ‚ç‚¹åŒ…å« `search_query` å­—æ®µ
- æ£€æŸ¥æœç´¢å¼•æ“ API é…ç½®

### é—®é¢˜ 2: æ•°æ®æºé¢æ¿ä¸ºç©º

**åŸå› ï¼š**
- èŠ‚ç‚¹çš„ `realtime_state.sources` ä¸ºç©º
- æœç´¢ç»“æœæœªè¿”å› `url` å­—æ®µ

**è§£å†³ï¼š**
- æ£€æŸ¥ Mock æ•°æ®æ˜¯å¦åŒ…å« `url`
- æ£€æŸ¥çœŸå® API è¿”å›æ ¼å¼

### é—®é¢˜ 3: Mock æ¨¡å¼ä¸å·¥ä½œ

**åŸå› ï¼š**
- é…ç½®äº†æœç´¢å¼•æ“ APIï¼Œä½† API æ— æ•ˆ

**è§£å†³ï¼š**
- åˆ é™¤ `.env` ä¸­çš„ `TAVILY_API_KEY` å’Œ `SERPER_API_KEY`
- é‡å¯åç«¯

---

## æ‰©å±•æ–¹å‘

### 1. æ—¶é—´åºåˆ—è¿½è¸ª
- è®°å½•èŠ‚ç‚¹çŠ¶æ€çš„å†å²å˜åŒ–
- æ˜¾ç¤ºè¶‹åŠ¿å›¾è¡¨

### 2. å¤šè¯­è¨€æ”¯æŒ
- è‡ªåŠ¨æ£€æµ‹æŸ¥è¯¢è¯­è¨€
- ç”Ÿæˆå¯¹åº”è¯­è¨€çš„ `search_query`

### 3. è‡ªå®šä¹‰æ•°æ®æº
- å…è®¸ç”¨æˆ·æŒ‡å®šæœç´¢å¼•æ“
- æ”¯æŒä¼ä¸šå†…éƒ¨æ•°æ®æº

### 4. å®æ—¶æ¨é€
- WebSocket è¿æ¥
- èŠ‚ç‚¹çŠ¶æ€å˜åŒ–æ—¶è‡ªåŠ¨æ›´æ–°

---

## æŠ€æœ¯äº®ç‚¹

âœ… **æ¨¡å—è§£è€¦** - Pass 1 å’Œ Pass 2 å®Œå…¨ç‹¬ç«‹  
âœ… **å¹¶å‘å¤„ç†** - ä½¿ç”¨ `asyncio.gather` æå‡æ€§èƒ½  
âœ… **é™çº§ç­–ç•¥** - Mock æ¨¡å¼ç¡®ä¿å¼€å‘ä½“éªŒ  
âœ… **æ•°æ®æº¯æº** - æ¯ä¸ªæ•°æ®ç‚¹éƒ½å¯è¿½æº¯åˆ°åŸå§‹æ¥æº  
âœ… **åå¹»è§‰æœºåˆ¶** - æ— æ•°æ®æ—¶è¿”å› "unknown"ï¼Œä¸æé€   
âœ… **ç”¨æˆ·ä½“éªŒ** - èŠ‚ç‚¹å¡ç‰‡ + å…¨å±€é¢æ¿åŒé‡å±•ç¤º  

---

## æ€»ç»“

åŒé˜¶æ®µæ¶æ„ + æ•°æ®æº¯æºç³»ç»Ÿå®ç°äº†ï¼š

1. **å®æ—¶è”ç½‘æ„ŸçŸ¥** - èŠ‚ç‚¹è‡ªåŠ¨è·å–æœ€æ–°çŠ¶æ€
2. **ä¸¥æ ¼æ•°æ®æº¯æº** - æ¯ä¸ªæ•°æ®ç‚¹éƒ½æœ‰æ¥æº
3. **å®Œæ•´å¯è¿½æº¯æ€§** - ç”¨æˆ·å¯ç‚¹å‡»æŸ¥çœ‹åŸæ–‡
4. **å¼€å‘å‹å¥½** - Mock æ¨¡å¼æ— éœ€çœŸå® API
5. **ç”Ÿäº§å°±ç»ª** - æ”¯æŒçœŸå®æœç´¢å¼•æ“ API

è¿™æ˜¯å› æœå¼•æ“ä»"é™æ€æ‹“æ‰‘å›¾"åˆ°"åŠ¨æ€æ™ºèƒ½ç³»ç»Ÿ"çš„å…³é”®å‡çº§ï¼

