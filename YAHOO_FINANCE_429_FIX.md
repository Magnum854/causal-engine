# Yahoo Finance 429 é”™è¯¯è§£å†³æ–¹æ¡ˆ

## é—®é¢˜è¯Šæ–­

### ç—‡çŠ¶
æ‰€æœ‰èŠ‚ç‚¹æ•°æ®æ˜¾ç¤º `unknown`ï¼ŒYahoo Finance æ— æ³•è·å–æ•°æ®ã€‚

### æ ¹æœ¬åŸå› 
ä»æ—¥å¿—å‘ç°ï¼š
```
2026-02-19 21:21:25 [ERROR] yfinance: 429 Client Error: Too Many Requests
2026-02-19 21:21:28 [ERROR] [YahooFinance] è·å–å¤±è´¥: DX-Y.NYB - Expecting value: line 1 column 1
```

**Yahoo Finance API è§¦å‘äº†é€Ÿç‡é™åˆ¶ï¼ˆRate Limitingï¼‰**

åŸå› ï¼š
1. çŸ­æ—¶é—´å†…å‘é€äº†å¤§é‡å¹¶å‘è¯·æ±‚
2. æ¯æ¬¡åˆ†æ"é»„é‡‘ä»·æ ¼"ä¼šåŒæ—¶è¯·æ±‚ 6-7 ä¸ªèŠ‚ç‚¹ï¼ˆç¾å…ƒæŒ‡æ•°ã€é»„é‡‘ä»·æ ¼ã€é»„é‡‘ä¾›åº”ã€é»„é‡‘éœ€æ±‚ç­‰ï¼‰
3. å¤šæ¬¡æµ‹è¯•å¯¼è‡´è¯·æ±‚ç´¯ç§¯ï¼Œè§¦å‘ Yahoo çš„åçˆ¬è™«æœºåˆ¶

---

## å·²å®æ–½çš„è§£å†³æ–¹æ¡ˆ

### 1. æ·»åŠ é‡è¯•æœºåˆ¶ + æŒ‡æ•°é€€é¿

ä¿®æ”¹äº† `yahoo_finance_service.py` çš„ `fetch_financial_data` æ–¹æ³•ï¼š

**æ–°å¢åŠŸèƒ½**ï¼š
- âœ… æœ€å¤šé‡è¯• 3 æ¬¡
- âœ… æŒ‡æ•°é€€é¿å»¶è¿Ÿï¼š2ç§’ â†’ 4ç§’ â†’ 8ç§’
- âœ… è‡ªåŠ¨æ£€æµ‹ 429 é”™è¯¯å¹¶é‡è¯•
- âœ… è¯¦ç»†çš„æ—¥å¿—è®°å½•

**ä»£ç é€»è¾‘**ï¼š
```python
for attempt in range(max_retries):
    try:
        if attempt > 0:
            delay = 2 ** attempt  # 2s, 4s, 8s
            await asyncio.sleep(delay)
        
        # è°ƒç”¨ yfinance
        stock = yf.Ticker(ticker)
        info = stock.info
        
        # è·å–æ•°æ®...
        return result
        
    except Exception as e:
        if "429" in str(e):
            # é€Ÿç‡é™åˆ¶ï¼Œç»§ç»­é‡è¯•
            continue
        else:
            # å…¶ä»–é”™è¯¯ï¼Œä¹Ÿé‡è¯•
            continue
```

---

## ä½¿ç”¨å»ºè®®

### 1. ç­‰å¾…é€Ÿç‡é™åˆ¶è§£é™¤

**å½“å‰çŠ¶æ€**ï¼šä½ çš„ IP å·²è¢« Yahoo Finance ä¸´æ—¶å°ç¦

**å»ºè®®ç­‰å¾…æ—¶é—´**ï¼š
- æœ€å°‘ç­‰å¾…ï¼š**15-30 åˆ†é’Ÿ**
- ä¿é™©ç­‰å¾…ï¼š**1-2 å°æ—¶**

### 2. æµ‹è¯•æ—¶å‡å°‘è¯·æ±‚é¢‘ç‡

**é¿å…**ï¼š
- âŒ è¿ç»­å¤šæ¬¡æµ‹è¯•åŒä¸€ä¸ªæŸ¥è¯¢
- âŒ çŸ­æ—¶é—´å†…æµ‹è¯•å¤šä¸ªä¸åŒæŸ¥è¯¢
- âŒ åˆ·æ–°é¡µé¢é‡å¤è¯·æ±‚

**æ¨è**ï¼š
- âœ… æ¯æ¬¡æµ‹è¯•åç­‰å¾… 30 ç§’
- âœ… ä½¿ç”¨ä¸åŒçš„æŸ¥è¯¢è¯ï¼ˆé¿å…é‡å¤èŠ‚ç‚¹ï¼‰
- âœ… å…ˆæµ‹è¯•å•ä¸ªç®€å•æŸ¥è¯¢

### 3. æµ‹è¯•æ­¥éª¤

**30åˆ†é’Ÿåï¼ŒæŒ‰ä»¥ä¸‹æ­¥éª¤æµ‹è¯•**ï¼š

1. **åˆ·æ–°æµè§ˆå™¨**ï¼ˆCtrl + Shift + Rï¼‰

2. **è¾“å…¥ç®€å•æŸ¥è¯¢**ï¼š`æ¯”ç‰¹å¸`
   - è¿™ä¸ªæŸ¥è¯¢åªä¼šç”Ÿæˆ 2-3 ä¸ªèŠ‚ç‚¹
   - å‡å°‘å¹¶å‘è¯·æ±‚æ•°é‡

3. **è§‚å¯Ÿæ—¥å¿—**ï¼š
   ```
   [YahooFinance] âœ“ æˆåŠŸ: BTC-USD = 50000.00 USD (rising, +2.5%)
   ```

4. **å¦‚æœä»ç„¶ 429**ï¼š
   - ç»§ç»­ç­‰å¾… 30 åˆ†é’Ÿ
   - æˆ–è€…åˆ‡æ¢ç½‘ç»œï¼ˆä½¿ç”¨æ‰‹æœºçƒ­ç‚¹ï¼‰

---

## é•¿æœŸä¼˜åŒ–å»ºè®®

### æ–¹æ¡ˆ 1: æ·»åŠ è¯·æ±‚é—´éš”ï¼ˆæ¨èï¼‰

åœ¨å¹¶å‘è¯·æ±‚ä¹‹é—´æ·»åŠ å»¶è¿Ÿï¼š

```python
# åœ¨ two_pass_causal_service.py çš„ _pass2_enrich_with_provenance ä¸­
async def _pass2_enrich_with_provenance(self, topology):
    nodes = topology["nodes"]
    enriched_nodes = []
    
    for node in nodes:
        result = await self._enrich_single_node(node)
        enriched_nodes.append(result)
        
        # æ·»åŠ å»¶è¿Ÿé¿å…é€Ÿç‡é™åˆ¶
        await asyncio.sleep(0.5)  # æ¯ä¸ªèŠ‚ç‚¹é—´éš” 0.5 ç§’
    
    return {"nodes": enriched_nodes, ...}
```

### æ–¹æ¡ˆ 2: ä½¿ç”¨ç¼“å­˜

ç¼“å­˜ Yahoo Finance æ•°æ®ï¼Œé¿å…é‡å¤è¯·æ±‚ï¼š

```python
from functools import lru_cache
from datetime import datetime, timedelta

class YahooFinanceService:
    def __init__(self):
        self.cache = {}  # {ticker: (data, timestamp)}
        self.cache_ttl = 300  # 5åˆ†é’Ÿç¼“å­˜
    
    async def fetch_financial_data(self, ticker, ...):
        # æ£€æŸ¥ç¼“å­˜
        if ticker in self.cache:
            data, timestamp = self.cache[ticker]
            if (datetime.now() - timestamp).seconds < self.cache_ttl:
                logger.info(f"[YahooFinance] ä½¿ç”¨ç¼“å­˜: {ticker}")
                return data
        
        # è·å–æ–°æ•°æ®
        result = await self._fetch_from_api(ticker)
        
        # æ›´æ–°ç¼“å­˜
        self.cache[ticker] = (result, datetime.now())
        return result
```

### æ–¹æ¡ˆ 3: ä½¿ç”¨ä»£ç†æ± 

å¦‚æœéœ€è¦é«˜é¢‘è¯·æ±‚ï¼Œè€ƒè™‘ä½¿ç”¨ä»£ç†æœåŠ¡ï¼š
- è½®æ¢ IP åœ°å€
- åˆ†æ•£è¯·æ±‚å‹åŠ›
- é¿å…å•ä¸ª IP è¢«å°ç¦

---

## å½“å‰ç³»ç»ŸçŠ¶æ€

âœ… **å·²ä¿®å¤**ï¼š
- é‡è¯•æœºåˆ¶å·²æ·»åŠ 
- æŒ‡æ•°é€€é¿å·²å®ç°
- 429 é”™è¯¯æ£€æµ‹å·²å¯ç”¨

â³ **ç­‰å¾…ä¸­**ï¼š
- Yahoo Finance é€Ÿç‡é™åˆ¶è§£é™¤ï¼ˆ15-30åˆ†é’Ÿï¼‰

ğŸ”„ **ä¸‹æ¬¡æµ‹è¯•**ï¼š
- ç­‰å¾… 30 åˆ†é’Ÿå
- ä½¿ç”¨ç®€å•æŸ¥è¯¢ï¼ˆå¦‚"æ¯”ç‰¹å¸"ï¼‰
- è§‚å¯Ÿæ˜¯å¦æˆåŠŸè·å–æ•°æ®

---

## æ•…éšœæ’æŸ¥

### å¦‚æœ 30 åˆ†é’Ÿåä»ç„¶å¤±è´¥

**æ£€æŸ¥ 1ï¼šç¡®è®¤åç«¯å·²é‡å¯**
```bash
# æŸ¥çœ‹æ—¥å¿—ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
[YahooFinance] åˆå§‹åŒ–å®Œæˆï¼Œæ”¯æŒ 49 ä¸ªèµ„äº§æ˜ å°„
```

**æ£€æŸ¥ 2ï¼šæµ‹è¯• yfinance æ˜¯å¦å¯ç”¨**
```python
import yfinance as yf
ticker = yf.Ticker("BTC-USD")
print(ticker.info.get("regularMarketPrice"))
```

**æ£€æŸ¥ 3ï¼šåˆ‡æ¢ç½‘ç»œ**
- ä½¿ç”¨æ‰‹æœºçƒ­ç‚¹
- æˆ–è€…ä½¿ç”¨ VPN

**æ£€æŸ¥ 4ï¼šé™çº§åˆ° Mock æ¨¡å¼**
å¦‚æœ Yahoo Finance æŒç»­ä¸å¯ç”¨ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨é™çº§åˆ°æ–°é—»æœç´¢æ¨¡å¼ã€‚

---

## æ€»ç»“

**é—®é¢˜**ï¼šYahoo Finance 429 é€Ÿç‡é™åˆ¶  
**åŸå› **ï¼šçŸ­æ—¶é—´å†…å‘é€äº†è¿‡å¤šè¯·æ±‚  
**è§£å†³**ï¼šæ·»åŠ é‡è¯•æœºåˆ¶ + æŒ‡æ•°é€€é¿  
**çŠ¶æ€**ï¼šç­‰å¾…é€Ÿç‡é™åˆ¶è§£é™¤ï¼ˆ15-30åˆ†é’Ÿï¼‰  
**æµ‹è¯•**ï¼š30åˆ†é’Ÿåä½¿ç”¨"æ¯”ç‰¹å¸"æŸ¥è¯¢æµ‹è¯•

---

ç”Ÿæˆæ—¶é—´: 2026-02-19 21:30  
æ–‡æ¡£ç‰ˆæœ¬: 1.0

